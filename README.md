# Gate Hardhat2 + Foundry EVM å¼€å‘æ¡†æ¶

è¿™æ˜¯ä¸€ä¸ªå°† Hardhat ä¸ Foundry æ— ç¼æ•´åˆçš„ Solidity å¼€å‘æ¡†æ¶ï¼Œæ—¢ä¿ç•™äº† Hardhat çš„æ’ä»¶ç”Ÿæ€ï¼ˆéƒ¨ç½²ã€éªŒè¯ã€è„šæœ¬æ‰§è¡Œã€TypeScript å¼€å‘ä½“éªŒï¼‰ï¼Œä¹Ÿåˆ©ç”¨ Foundry çš„é«˜é€Ÿ EVMã€æµ‹è¯•ä¸è„šæœ¬æ‰§è¡Œèƒ½åŠ›ã€‚é€‚ç”¨äºå¤æ‚åˆçº¦å¼€å‘ã€æµ‹è¯•é©±åŠ¨å¼€å‘ (TDD)ã€å¤šç¯å¢ƒéƒ¨ç½²ä¸é«˜çº§è°ƒè¯•éœ€æ±‚ã€‚

åŒæ—¶æœ¬é¡¹ç›®é›†æˆäº† check / sync / validate ä¸‰ä¸ªæ ¸å¿ƒå‘½ä»¤ï¼Œæ„å»ºå‡ºä¸€å¥—å®Œæ•´çš„æ™ºèƒ½åˆçº¦å‡çº§ä¸å®‰å…¨éªŒè¯æµç¨‹ã€‚

## åŠŸèƒ½ç‰¹æ€§
åŠŸèƒ½ä¸€ï¼š å­—èŠ‚ç æ£€æŸ¥ï¼ˆcheckï¼‰
åŠŸèƒ½äºŒï¼š åˆçº¦çŠ¶æ€åŒæ­¥ï¼ˆsyncï¼‰
åŠŸèƒ½ä¸‰ï¼š å‡çº§éªŒè¯ï¼ˆvalidateï¼‰

### åŠŸèƒ½ä¸€ï¼š å­—èŠ‚ç æ£€æŸ¥ï¼ˆcheckï¼‰
- âœ… æ£€æŸ¥é“¾ä¸‹åˆçº¦ä»£ç å’Œé“¾ä¸Šåˆçº¦ä»£ç æ˜¯å¦ä¸€è‡´
- âœ… æ”¯æŒæ£€æŸ¥å•ä¸ªåˆçº¦ã€æŒ‡å®šç½‘ç»œæˆ–æ‰€æœ‰åˆçº¦
- âœ… æ™ºèƒ½è¯†åˆ« Constructor å‚æ•°å·®å¼‚å’Œ Immutable å˜é‡å·®å¼‚
- âœ… è‡ªåŠ¨ç§»é™¤å…ƒæ•°æ®è¿›è¡Œæ¯”è¾ƒ
- âœ… ç”Ÿæˆè¯¦ç»†çš„ JSON æŠ¥å‘Š
- âœ… æ”¯æŒå¢é‡æ›´æ–°æŠ¥å‘Š

#### 1. ä¿®æ”¹é…ç½®æ–‡ä»¶

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `contractInfo.json` æ–‡ä»¶ï¼š

```json
{
  "eth": {
    "Vault": "0x80aaf2e4636c510e067a5d300d8bafd48027addf",
    "VaultCrossChainRelay": "0x060194eec4556096baaabd6bf553d2658d6a66ab"
  },
  "bsc": {
    "Vault": "0x2cb7d2603a5f43b9fe79e98f09fe3eec40b6765d",
    "VaultCrossChainRelay": "0x23ae3a565e0896866e7725fe6d49fd777359c162"
  }
}
```

æ ¼å¼è¯´æ˜ï¼š
- ç¬¬ä¸€å±‚ key æ˜¯ç½‘ç»œåç§°ï¼ˆå¿…é¡»ä¸ `hardhat.config.js` ä¸­çš„ç½‘ç»œåç§°ä¸€è‡´ï¼‰
- ç¬¬äºŒå±‚ key æ˜¯åˆçº¦åç§°ï¼ˆå¿…é¡»ä¸ç¼–è¯‘çš„åˆçº¦åç§°ä¸€è‡´ï¼‰
- value æ˜¯åˆçº¦åœ°å€

#### 2. é…ç½® Hardhat

ç¡®ä¿ `hardhat.config.js` ä¸­é…ç½®äº†ç›¸åº”çš„ç½‘ç»œï¼š

```javascript
module.exports = {
  networks: {
    eth: {
      url: "https://eth-mainnet.g.alchemy.com/v2/YOUR-API-KEY",
    },
    bsc: {
      url: "https://bsc-dataseed.binance.org/",
    }
  }
};
```

#### 3. ä½¿ç”¨å·¥å…·

##### ğŸ“‹ æŸ¥çœ‹å¸®åŠ©

```bash
npx gate-tool --help
```

##### ğŸ” å­—èŠ‚ç æ£€æŸ¥

```bash
# æ£€æŸ¥æ‰€æœ‰åˆçº¦
npx gate-tool check

# æ£€æŸ¥æŒ‡å®šåˆçº¦
npx gate-tool check --contract Vault

# æ£€æŸ¥æŒ‡å®šç½‘ç»œ
npx gate-tool check --network eth

# æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„
npx gate-tool check --config ./config/contracts.json

# æŒ‡å®šè¾“å‡ºæŠ¥å‘Šè·¯å¾„
npx gate-tool check --output ./reports/result.json
```

### åŠŸèƒ½äºŒï¼š åˆçº¦çŠ¶æ€åŒæ­¥ï¼ˆsyncï¼‰
- âœ… åŒæ­¥é“¾ä¸Šåˆçº¦çŠ¶æ€åˆ°æœ¬åœ° .openzeppelin æ–‡ä»¶
- âœ… è‡ªåŠ¨è¯»å–é“¾ä¸Šå®ç°åˆçº¦åœ°å€
- âœ… è·å–å¹¶æ›´æ–°å­˜å‚¨å¸ƒå±€ä¿¡æ¯

#### 1. åŒæ­¥é“¾ä¸Šåˆçº¦çŠ¶æ€

å½“åˆçº¦é€šè¿‡ calldata æ–¹å¼ç”±å…¶ä»–äººï¼ˆå¦‚å¤šç­¾é’±åŒ…ï¼‰æ‰§è¡Œå‡çº§åï¼Œæœ¬åœ°çš„ `.openzeppelin` æ–‡ä»¶ä¸ä¼šè‡ªåŠ¨æ›´æ–°ã€‚ä½¿ç”¨æ­¤å‘½ä»¤å¯ä»¥ä»é“¾ä¸Šè¯»å–æœ€æ–°çŠ¶æ€å¹¶æ›´æ–°æœ¬åœ°æ–‡ä»¶ã€‚

```bash
# åŒæ­¥åˆçº¦çŠ¶æ€
npx gate-tool sync \
  --proxy 0x1234... \
  --contract CounterUUPS \
  --network sepolia
```

### åŠŸèƒ½ä¸‰ï¼š å‡çº§éªŒè¯ï¼ˆvalidateï¼‰
- âœ… éªŒè¯åˆçº¦å‡çº§çš„å®‰å…¨æ€§
- âœ… æ£€æŸ¥å­˜å‚¨å¸ƒå±€å…¼å®¹æ€§
- âœ… è‡ªåŠ¨éƒ¨ç½²æ–°å®ç°åˆçº¦
- âœ… ç”Ÿæˆ upgradeToAndCall çš„ calldata
- âœ… æ”¯æŒåŒä¸€åˆçº¦å’Œä¸åŒåˆçº¦çš„å‡çº§æ¨¡å¼

#### 1. éªŒè¯å‡çº§å®‰å…¨æ€§å¹¶ç”Ÿæˆ calldata

éªŒè¯åˆçº¦å‡çº§çš„å®‰å…¨æ€§ï¼Œå¹¶ç”Ÿæˆ `upgradeToAndCall` çš„ calldataã€‚

```bash
# ä¸åŒåˆçº¦å‡çº§ï¼ˆä» CounterUUPS å‡çº§åˆ° CounterUUPSV2ï¼‰
npx gate-tool validate \
  --proxy 0x1234... \
  --old CounterUUPS \
  --new CounterUUPSV2 \
  --network sepolia

# åŒä¸€åˆçº¦å‡çº§ï¼ˆä¿®æ”¹ç°æœ‰åˆçº¦åå‡çº§ï¼‰
npx gate-tool validate \
  --proxy 0x1234... \
  --old CounterUUPS \
  --new CounterUUPS \
  --network sepolia

# æŒ‡å®šè¾“å‡ºæ–‡ä»¶è·¯å¾„
npx gate-tool validate \
  --proxy 0x1234... \
  --old CounterUUPS \
  --new CounterUUPSV2 \
  --network sepolia \
  --output ./upgrade-info.json
```

**æ³¨æ„ï¼š** `validate` å‘½ä»¤ä¼šåœ¨é“¾ä¸Šéƒ¨ç½²æ–°çš„å®ç°åˆçº¦ï¼ˆä»…ç”¨äºéªŒè¯ï¼‰ï¼Œä½†ä¸ä¼šå‡çº§ä»£ç†åˆçº¦ã€‚è¯·ä½¿ç”¨ç”Ÿæˆçš„ calldata é€šè¿‡å¤šç­¾é’±åŒ…æ‰§è¡Œå‡çº§ã€‚

## å‘½ä»¤é€‰é¡¹

### check å‘½ä»¤

| é€‰é¡¹ | ç®€å†™ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|--------|
| `--contract <name>` | `-c` | æŒ‡å®šè¦æ£€æŸ¥çš„åˆçº¦åç§° | - |
| `--network <name>` | `-n` | æŒ‡å®šè¦æ£€æŸ¥çš„ç½‘ç»œåç§° | - |
| `--config <path>` | - | æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ | `./contractInfo.json` |
| `--output <path>` | `-o` | æŒ‡å®šè¾“å‡ºæŠ¥å‘Šæ–‡ä»¶è·¯å¾„ | `./bytecode-check-report.json` |

### sync å‘½ä»¤

| é€‰é¡¹ | ç®€å†™ | è¯´æ˜ | å¿…éœ€ |
|------|------|------|------|
| `--proxy <address>` | - | ä»£ç†åˆçº¦åœ°å€ | âœ… |
| `--contract <name>` | - | åˆçº¦åç§° | âœ… |
| `--network <name>` | `-n` | ç½‘ç»œåç§° | - |

### validate å‘½ä»¤

| é€‰é¡¹ | ç®€å†™ | è¯´æ˜ | å¿…éœ€ |
|------|------|------|------|
| `--proxy <address>` | - | ä»£ç†åˆçº¦åœ°å€ | âœ… |
| `--old <name>` | - | æ—§åˆçº¦åç§° | âœ… |
| `--new <name>` | - | æ–°åˆçº¦åç§° | âœ… |
| `--network <name>` | `-n` | ç½‘ç»œåç§° | - |
| `--output <path>` | `-o` | è¾“å‡ºæ–‡ä»¶è·¯å¾„ | `./upgradeCalldata.json` |